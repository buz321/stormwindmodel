---
title: "Visualization Tests"
author: "Jordan Robinson"
date: "3/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Purpose

Showing visualization examples that can be pulled from data.

```{r}
library(stormwindmodel)
library(tidyverse)
library(ggplot2)

storm_data <- floyd_tracks
grid_data <- county_points
```


Use functions to pull storm data. In this case, winds
```{r, echo = FALSE, include = FALSE}
wind_map_data <- calc_grid_winds2()
wind_max_sust <- wind_map_data[["vmax_sust"]]
wind_surface_dir <- wind_map_data[["surface_wind_direction"]]
wind_surface_dir_specific <- wind_surface_dir["1999-09-15 17:00:00",]
wind_max_sust_specific <- wind_max_sust["1999-09-15 17:00:00",]
```

Basic Plot -  max wind speed at each location based on get_grid_winds, which pulls max from cal_grid_winds2 matrix
```{r}
base_plot <- get_grid_winds(storm_data, grid_data)
map_wind(base_plot)
```

New Plot - take all points at a specific time and plot
```{r}

county_data <- tigris:::counties(state = c("NC"), cb = T, class = "sf")

storm_center <- create_full_track(storm_data)
storm_center <- storm_center[as.character(storm_center$date) == c("1999-09-15 17:00:00"),]

wind_summary <- data.frame(wind_max_sust_specific, wind_surface_dir_specific)
grid_data_sum <- grid_data[grid_data$gridid %in% rownames(wind_summary),]
practice <- right_join(rownames_to_column(wind_summary), grid_data_sum, 
                       by = c("rowname" ="gridid"))

#practice <- practice[practice$wind_max_sust_specific >0.5,]
# 
# #county_data <- county_data[county_data$GEOID %in% practice$rowname,]
practice <- practice[practice$rowname %in% county_data$GEOID,]
sf_plot <- sf:::st_as_sf(practice, coords = c("glon", "glat")) %>% 
   sf:::st_set_crs(4269)

#merge counties w/ fibs
#Code 1
# ggplot() + 
#   geom_sf(data = county_data) +
#    geom_sf(data = sf_plot)#+
  # metR::geom_arrow(data  = practice, aes(x = wind_max, y = sust_dur,
  #                      dx = glon, 
  #                      dy =glat),
  #                      arrow.type = "closed",
  #                      #arrow.length = practice$vmax_gust,
  #                      show.legend = TRUE)

#Code 2
ggplot() + 
  geom_sf(data = county_data) +
  geom_sf(data = sf_plot)+
  geom_spoke(data = practice, aes(x = glon, y = glat,
                                     angle = wind_surface_dir_specific* pi / 180,
                                     color = wind_max_sust_specific,
                                     radius = wind_max_sust_specific/2
                                     ),
               arrow = arrow(length = unit(.075, 'inches')),
               show.legend = TRUE)+
  scale_color_gradient(low='darkblue', high='red')+
  geom_point(data = storm_center, aes(x = tclon, y = tclat), color = "green")
  
```

#using st_make_object to set grid first
```{r}
grid_spacing <- 8000
test <- sf::st_make_grid(county_data, square = TRUE, what = "centers")%>% 
  st_sf() %>% 
  mutate(gridid = as.character(1:n()))

grid_to_model <- test %>% 
  st_transform(4269) %>%
  st_geometry() %>%
  unlist() %>%
  matrix(ncol = 2,byrow = TRUE) %>%
  as_tibble() %>%
  setNames(c("glon","glat")) %>%
  mutate(gridid = as.character(1:n()),
         glandsea = TRUE) %>%
  select(gridid, glat, glon, glandsea)

 ggplot()+
  geom_sf(data = county_data)+
  geom_sf(data = test)

```

grid_spacing <- 4000
example_grid <- st_make_grid(example_county, square = TRUE, what = "centers",
                        cellsize = c(grid_spacing, grid_spacing)) %>% 
  st_sf() %>% 
  mutate(gridid = as.character(1:n()))

grid_to_model <- example_grid %>% 
  st_transform(4269) %>% 
  st_geometry() %>% 
  unlist() %>% 
  matrix(ncol = 2,byrow = TRUE) %>% 
  as_tibble() %>% 
  setNames(c("glon","glat")) %>% 
  mutate(gridid = as.character(1:n()),
         glandsea = TRUE) %>% 
  select(gridid, glat, glon, glandsea)

example_winds <- get_grid_winds(hurr_track = example_storm_track,
                                grid_df = grid_to_model)

example_grid <- example_grid %>% 
  left_join(example_winds, by = "gridid")
  
#From Git  
```{r}
nc = read_sf(system.file("shape/nc.shp", package="sf"))
g = st_make_grid(nc)
plot(g)
plot(st_geometry(nc), add = TRUE)
# g[nc] selects cells that intersect with nc:
plot(g[nc], col = '#ff000088', add = TRUE)
```
